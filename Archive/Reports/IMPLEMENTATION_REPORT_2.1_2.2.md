# Project Harmony — 2.1 & 2.2 实现报告

## 概述

本次实现覆盖了《Project Harmony》后续开发计划中的 **2.1 内容层面** 和 **2.2 核心玩法系统** 两大模块，共新增/修改 **13 个文件**，新增约 **6,762 行** GDScript 代码。

---

## 2.1 内容层面实现

### 2.1.1 ChapterData 扩展（chapter_data.gd）

| 章节 | 主题 | Boss | 特色敌人 | 精英敌人 | 状态 |
|------|------|------|----------|----------|------|
| 第一章 | 古典 | 毕达哥拉斯 | 节拍行者 | 和弦卫士 | 已有 |
| 第二章 | 摇滚 | 失真暴君 | 失真咆哮者 | 反馈尖啸者 | 已有 |
| 第三章 | 电子 | 量化暴君 | 合成脉冲 | 序列追踪者 | 已有 |
| 第四章 | 民谣 | 沉默织者 | 回声游吟者 | 根音守卫 | 已有 |
| 第五章 | 交响 | 指挥者 | 渐强涌潮 | 对位编织者 | 已有 |
| **第六章** | **爵士** | **切分行者** | **行走低音** | **拟声歌手** | **新增** |
| **第七章** | **噪音** | **合成主脑** | **比特粉碎虫** | **故障幻影** | **新增** |

新增了完整的第六章和第七章数据配置，包括：
- 章节元数据（名称、描述、BPM、调式、颜色主题）
- Boss 配置（血量、伤害、阶段阈值、特殊机制）
- 敌人波次配置（普通敌人、特色敌人、精英敌人的生成时间和数量）
- 章节特殊机制（爵士即兴系统、噪音信号干扰系统）

### 2.1.2 ChapterManager 增强（chapter_manager.gd）

重写了章节管理器，新增以下功能：

- **章节过渡系统**：完整的淡出→加载→淡入过渡动画，支持 BPM 渐变、调式切换
- **Boss 生成系统**：根据章节数据自动实例化对应 Boss，配置血量和阶段参数
- **章节特殊机制**：每个章节的独特游戏机制（如爵士章的切分奖励、噪音章的信号干扰）
- **过渡视觉效果**：章节名称浮动显示、颜色主题切换、屏幕闪烁
- **进度追踪**：章节内进度百分比、Boss 击败检测、自动推进

### 2.1.3 Boss 实现

#### boss_jazz.gd — 切分行者（第六章 Boss）

| 阶段 | 名称 | 血量阈值 | 核心机制 |
|------|------|----------|----------|
| 1 | 切分节奏 | 100%→75% | 切分弹幕（弱拍发射）、摇摆低音线 |
| 2 | 即兴独奏 | 75%→50% | 即兴音符序列、蓝调音阶攻击 |
| 3 | 蓝调悲歌 | 50%→25% | 蓝调之泪（追踪弹）、悲伤光环（减速） |
| 4 | 自由爵士 | 25%→0% | 混沌弹幕、节奏解构、全屏即兴 |

特色机制：
- **切分计数器**：玩家在弱拍命中 Boss 获得额外伤害加成
- **即兴序列**：Boss 随机生成音符序列，玩家需要用对应音符反击
- **蓝调音阶**：特殊的五声音阶弹幕模式

#### boss_noise.gd — 合成主脑（第七章 Boss）

| 阶段 | 名称 | 血量阈值 | 核心机制 |
|------|------|----------|----------|
| 1 | 数字化 | 100%→75% | 比特粉碎弹幕、量化网格 |
| 2 | 故障扩散 | 75%→50% | 故障传送、数据碎片风暴 |
| 3 | 信号干扰 | 50%→25% | 白噪音脉冲、频率干扰（扭曲玩家输入） |
| 4 | 白噪音 | 25%→0% | 全频段攻击、信号过载、最终崩溃 |

特色机制：
- **信号降级**：Boss 攻击会降低玩家法术的"信号质量"，导致伤害衰减
- **故障传送**：Boss 随机传送到屏幕上的"故障点"
- **频率干扰**：干扰玩家的音符输入，随机替换按键映射

### 2.1.4 特色敌人实现

| 文件 | 敌人名称 | 章节 | 类型 | 核心行为 |
|------|----------|------|------|----------|
| ch6_walking_bass.gd | 行走低音 | 第六章 | 特色 | 节奏步伐移动、低频脉冲攻击、步行路径预测 |
| ch6_scat_singer.gd | 拟声歌手 | 第六章 | 精英 | 即兴音节弹幕、和声护盾、拟声回声 |
| ch7_bitcrusher_worm.gd | 比特粉碎虫 | 第七章 | 特色 | 量化攻击、信号降级光环、像素化移动 |
| ch7_glitch_phantom.gd | 故障幻影 | 第七章 | 精英 | 数据损坏攻击、缓冲溢出、故障分身 |

---

## 2.2 核心玩法系统实现

### 2.2.1 召唤系统 — 幻影声部（summon_manager.gd）

通过小七和弦（Minor 7th）触发，根据当前音色系别决定召唤类型：

| 音色 | 召唤类型 | 行为描述 |
|------|----------|----------|
| 弹拨 (PLUCKED) | 伴奏声部 | 轨道跟随玩家，自动攻击最近敌人 |
| 拉弦 (BOWED) | 共鸣声部 | 固定位置，为范围内法术提供伤害加成 |
| 吹奏 (WIND) | 干扰声部 | 巡逻移动，减速和持续伤害附近敌人 |
| 打击 (PERCUSSIVE) | 节奏声部 | 跟随玩家，在每个节拍释放脉冲波 |

系统特性：
- 最多同时存在 4 个召唤物，超出时替换最旧的
- 召唤物有持续时间（12秒基础），接近过期时闪烁提示
- **共鸣机制**：多个共鸣声部叠加增伤，2个以上有协同加成
- 召唤物维护消耗疲劳值，与疲劳系统深度集成
- 完整的视觉表现：不同形状（星形/八角/三角/菱形）、光环、脉冲动画

### 2.2.2 法术视觉效果管理器（spell_visual_manager.gd）

为所有 15 种法术形态提供独立的视觉效果层：

| 法术形态 | 视觉效果 |
|----------|----------|
| 强化弹体 | 金色光芒爆发 + 径向粒子 |
| DOT弹体 | 紫色毒雾扩散 |
| 爆炸弹体 | 橙色火焰爆发 + 内核闪光 |
| 冲击波 | 多层环形扩散 + 地面裂纹 |
| 法阵/区域 | 旋转魔法阵 + 十字线 + 符文 |
| 天降打击 | 预警标记 → 光柱下降 → 落地冲击波 |
| 护盾/治疗 | 六角护盾 + 上升治疗粒子 |
| 召唤 | 召唤阵旋转 + 凝聚粒子 |
| 蓄力弹体 | 能量聚集 → 释放闪光 |
| 风暴区域 | 旋转漩涡臂 |
| 圣光领域 | 金色光柱 + 持续上升光粒 |
| 湮灭射线 | 紫色激光 + 灼烧粒子 |
| 时空裂隙 | 黑洞中心 + 反向旋转扭曲环 |
| 交响风暴 | 多色波次冲击波 |
| 终焉乐章 | 全屏白色闪光 + 多层红色冲击 |

额外视觉效果：
- 施法光环（单音/和弦双层）
- 和弦进行完成特效（D→T/T→D/PD→D 不同颜色）
- 修饰符视觉（穿透/追踪/分裂/回响/散射各有特效）
- 暴击闪光 + 浮动文字
- 法术名称浮动显示

### 2.2.3 序列器拖拽编辑 UI（sequencer_ui.gd 重写）

完全重写了序列器 UI，新增功能：

- **拖拽编辑**：从音符调色板拖拽音符到序列器格子，或在格子间拖拽移动
- **音符调色板**：底部显示 7 个白键音符（C-B），带颜色标识和选中高亮
- **编辑模式切换**：Note/Chord/Rest 三种模式，通过按钮或快捷键切换
- **悬停预览**：鼠标悬停显示音符属性（DMG/SPD/DUR/SIZE）
- **工具提示**：详细的音符/和弦/休止符信息
- **节奏型指示器**：每个小节下方显示当前节奏型名称
- **滚轮切换**：鼠标滚轮快速切换选中音符
- **右键清除**：右键点击清除格子为休止符
- **拖拽幽灵**：拖拽时显示半透明的音符预览
- **播放头增强**：顶部三角指示器 + 节拍闪烁

### 2.2.4 音色切换快捷轮盘（timbre_wheel_ui.gd）

按住 Tab 键弹出的径向选择轮盘：

- **四方向布局**：弹拨(上)、拉弦(右)、吹奏(下)、打击(左)
- **时间减速**：打开轮盘时游戏速度降至 20%，给玩家思考时间
- **扇区详情**：每个扇区显示音色名称、乐器类型、对应召唤类型
- **ADSR 预览**：选中扇区时显示 ADSR 包络波形缩略图
- **当前标记**：菱形标记指示当前激活的音色
- **开关动画**：平滑的展开/收起过渡动画
- **松开确认**：松开 Tab 键确认选择，避免误操作

### 2.2.5 召唤物 HUD（summon_hud.gd）

屏幕右侧的紧凑状态面板：

- 显示当前活跃的幻影声部列表（最多4个）
- 每个槽位显示：类型名称、颜色标识、剩余时间条、ID
- 共鸣加成百分比显示
- 时间条颜色变化（<3秒变红警告）

---

## 文件清单

| 文件路径 | 行数 | 类型 |
|----------|------|------|
| `scripts/data/chapter_data.gd` | 907 | 修改 |
| `scripts/systems/chapter_manager.gd` | 676 | 修改 |
| `scripts/entities/enemies/bosses/boss_jazz.gd` | 1,040 | 新增 |
| `scripts/entities/enemies/bosses/boss_noise.gd` | 1,210 | 新增 |
| `scripts/entities/enemies/chapter_enemies/ch6_walking_bass.gd` | 264 | 新增 |
| `scripts/entities/enemies/chapter_enemies/ch6_scat_singer.gd` | 325 | 新增 |
| `scripts/entities/enemies/chapter_enemies/ch7_bitcrusher_worm.gd` | 401 | 新增 |
| `scripts/entities/enemies/chapter_enemies/ch7_glitch_phantom.gd` | 422 | 新增 |
| `scripts/systems/summon_manager.gd` | 689 | 新增 |
| `scripts/systems/spell_visual_manager.gd` | 859 | 新增 |
| `scripts/ui/sequencer_ui.gd` | 575 | 重写 |
| `scripts/ui/timbre_wheel_ui.gd` | 390 | 新增 |
| `scripts/ui/summon_hud.gd` | 140 | 新增 |
| **总计** | **7,898** | |

---

## 集成说明

### 新增 Autoload 节点
以下脚本需要在 Godot 项目设置中注册为 Autoload：
- `SummonManager` → `res://scripts/systems/summon_manager.gd`

### 新增场景节点
以下脚本需要添加到游戏场景中：
- `SpellVisualManager` → 作为 Node2D 添加到主游戏场景
- `TimbreWheelUI` → 作为 Control 添加到 HUD CanvasLayer
- `SummonHUD` → 作为 Control 添加到 HUD CanvasLayer

### 信号连接
所有信号连接均在各脚本的 `_ready()` 中自动完成，无需手动配置。
