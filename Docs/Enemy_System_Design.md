# 敌人系统设计文档

**版本:** 1.0
**最后更新:** 2026-02-11
**状态:** 已实现

> **关联代码**: `godot_project/scripts/entities/enemy_base.gd` 及 `enemies/` 子目录

---

## 1. 核心设计理念：不和谐的具象化 (Dissonance Incarnate)

**主题定位**：如果玩家是「作曲家」，敌人就是「视觉噪音」、「静默」或「刺耳的干扰音」。

**视觉风格**：敌人具有明显的**故障艺术（Glitch Art）**特征。

- **锯齿状/碎片化**：造型不圆润，充满尖角。
- **低帧率动画**：代码中特意实现了 `quantized_fps`（量化帧率），让敌人的移动和旋转呈现出一种「抽帧」或「定格动画」的机械感（如 12 FPS），与玩家流畅的 60 FPS 形成视觉冲突。
- **动态故障**：生命值越低，敌人的视觉故障（闪烁、透明度抖动）越严重，仿佛不稳定的信号即将崩溃。

---

## 2. 行为机制：量化与节奏

敌人的行动模式打破传统 Survivor 类游戏的「平滑追踪」，采用基于时间或节奏的「步进」模式。

### 2.1 量化移动 (Quantized Movement)

- **机制**：敌人不是每帧移动，而是根据 `_quantize_interval` 定期「跳跃」到新位置。
- **效果**：敌人的移动看起来像是在一个低帧率的世界里运行，与玩家流畅的移动形成鲜明对比。

### 2.2 弱拍移动 (Offbeat Movement)

- **机制**：通过 `move_on_offbeat` 标志，敌人在强拍时冻结，弱拍时移动。
- **效果**：玩家在强拍施法，敌人在弱拍逼近，形成「你攻我进」的节奏博弈。

### 2.3 完美卡拍击退 (Perfect Beat Knockback)

- **机制**：玩家在完美节拍时刻攻击敌人，获得额外伤害和击退加成。
- **参数**：`perfect_beat_damage_multiplier = 1.5`，`perfect_beat_knockback_multiplier = 2.5`。

---

## 3. 噪音分类学 — 五种敌人类型

| 类型 | 音乐隐喻 | 视觉特征 | 量化帧率 | HP | 速度 | 特殊机制 |
|:---|:---|:---|:---:|:---:|:---:|:---|
| **Static (底噪)** | 白噪声 | 小型锯齿碎片，红色 | 16 FPS | 30 | 80 | 群体加速，数量压制 |
| **Silence (寂静)** | 休止符/黑洞 | 深色旋涡，半透明 | 6 FPS | 120 | 35 | 静音光环，增加疲劳 |
| **Screech (尖啸)** | 反馈音 | 尖锐三角，黄白色 | 20 FPS | 15 | 150 | 冲刺，死亡爆发不和谐区域 |
| **Pulse (脉冲)** | 错误节拍器 | 菱形，电蓝色 | 10 FPS | 60 | 55 | 蓄力-释放周期，环形弹幕 |
| **Wall (音墙)** | 砖墙限制器 | 巨大多边形，灰紫色 | 4 FPS | 200 | 25 | 护盾，地震冲击波，推力 |

### 3.1 Static (底噪)

最基础的敌人，数量巨大，直线蜂拥而至。代表无处不在的背景噪音。

- **群体加速**：附近同类越多，移动越快（最高 1.6x）。
- **视觉抖动**：持续的随机位移，模拟白噪声的不确定性。

### 3.2 Silence (寂静)

试图吞噬声音的黑洞。缓慢但不可阻挡。

- **静音光环**：120px 半径，玩家在内时每秒增加 0.08 疲劳度。
- **法术削减**：光环内法术伤害降低 40%。
- **击杀奖励**：死亡时降低玩家 0.1 疲劳度。

### 3.3 Screech (尖啸)

刺耳的反馈音，短暂但极具破坏力。

- **冲刺**：靠近玩家 200px 时以 3x 速度冲刺。
- **死亡爆发**：80px 范围内造成 15 伤害 + 0.12 不和谐度。
- **不和谐区域**：死亡后留下短暂的伤害场。

### 3.4 Pulse (脉冲)

错误的节拍器，在不该出现的时间点爆发。

- **蓄力-释放**：每 4 拍蓄力，然后冲刺或发射 8 发环形弹幕。
- **交替攻击**：冲刺和弹幕交替进行。
- **死亡弹幕**：死亡时释放半数弱弹幕。

### 3.5 Wall (音墙)

过度压缩的音墙，将所有动态范围压平。

- **护盾**：50 HP 额外护盾层，受击后 3 秒开始恢复。
- **推力**：60px 内持续推开玩家。
- **地震冲击波**：每 6 秒（约每 N 拍）释放 150px 范围冲击波。

---

## 4. 频谱相位形态 (Spectrum Phase Forms)

频谱相位系统（共鸣切片）为每种敌人赋予了三套独立的形态，当玩家切换频谱相位时，敌人的外观、行为和弱点将发生根本性变化。这一机制将战斗从单纯的反应力比拼转变为策略性的解谜过程。详细的系统设计请参阅 [ResonanceSlicing_System_Design.md](ResonanceSlicing_System_Design.md)。

### 4.1 Static (底噪) 相位形态

| 相位 | 形态变化 | 数值修正 | 战术意义 |
|:---|:---|:---|:---|
| **全频 (Fundamental)** | 原始形态，红色锯齿碎片 | HP 30, 速度 80 | 标准威胁 |
| **高通 (Overtone)** | 缩小为明亮的光点，线框化 | HP 10, 速度 160 | 极快但脆弱，适合爆发清场 |
| **低通 (Sub-Bass)** | 膨胀为巨大的模糊雾团 | HP 60, 速度 20, 无伤害 | 不造成伤害但减速玩家，阻碍走位 |

### 4.2 Silence (寂静) 相位形态

| 相位 | 形态变化 | 数值修正 | 战术意义 |
|:---|:---|:---|:---|
| **全频 (Fundamental)** | 原始形态，深色旋涡 | HP 120, 光环 120px | 标准威胁 |
| **高通 (Overtone)** | 静音光环消失，暴露出发光核心 | HP 120, 可暴击 (2x) | 唯一能高效击杀 Silence 的时机 |
| **低通 (Sub-Bass)** | 光环范围扩大，颜色变深 | HP 120, 光环 180px, 疲劳×2 | 极度危险，必须快速脱离 |

### 4.3 Screech (尖啸) 相位形态

| 相位 | 形态变化 | 数值修正 | 战术意义 |
|:---|:---|:---|:---|
| **全频 (Fundamental)** | 原始形态，尖锐三角 | HP 15, 速度 150 | 标准威胁 |
| **高通 (Overtone)** | 变为闪烁的高频电弧 | HP 5, 瞬移代替冲刺 | 极难命中但一击即杀 |
| **低通 (Sub-Bass)** | 被压缩为静止的光球 | HP 15, 速度 0 | 完全被压制，可安全清除 |

### 4.4 Pulse (脉冲) 相位形态

| 相位 | 形态变化 | 数值修正 | 战术意义 |
|:---|:---|:---|:---|
| **全频 (Fundamental)** | 原始形态，菱形 | HP 60, 8发环形弹幕 | 标准威胁 |
| **高通 (Overtone)** | 变为棱角分明的晶体 | HP 60, 弹幕变为 8 道瞬发激光 | 激光无法躲避但有间隙，考验走位 |
| **低通 (Sub-Bass)** | 变为质感沉重的能量球 | HP 60, 弹幕变为全屏震荡波 | 震荡波可用霸体硬抗，低通相位受伤-50% |

### 4.5 Wall (音墙) 相位形态

| 相位 | 形态变化 | 数值修正 | 战术意义 |
|:---|:---|:---|:---|
| **全频 (Fundamental)** | 原始形态，巨大多边形 | HP 200, 护盾 50 | 标准威胁 |
| **高通 (Overtone)** | 护盾消失，缩小为线框骨架 | HP 200, 速度 +30%, 无护盾 | 可被直接攻击但移动更快 |
| **低通 (Sub-Bass)** | 体积增大，变为实心巨石 | 不可摧毁，速度 10 | 可作为临时掩体躲避其他攻击 |

### 4.6 实现要点

每个敌人场景将包含三套独立的碰撞体和视觉节点，分别对应全频、高通和低通相位。当 `PhaseManager` 单例广播相位切换信号时，敌人脚本将执行以下操作：

1. 切换对应相位的碰撞体 `disabled` 属性
2. 切换对应相位的视觉节点 `visible` 属性
3. 切换到对应相位的行为状态机

新增信号：
```
phase_changed(new_phase: int)  → 所有敌人实体
# new_phase: 0=Fundamental, 1=Overtone, 2=Sub-Bass
```

---

## 5. 波次系统

### 5.1 波次类型

| 波次类型 | 描述 | 敌人预算倍率 |
|:---|:---|:---:|
| Normal | 混合波，权重随机 | 1.0x |
| Swarm | 蜂群波，大量 Static | 2.5x |
| Elite | 精英波，少量强敌 | 0.3x |
| Silence Tide | 寂静潮，Silence + Static 护卫 | 0.8x |
| Pulse Storm | 脉冲风暴，多个 Pulse 同步弹幕 | 0.5x |

### 5.2 难度递增

每 60 秒提升一个难度等级：

- HP: ×1.15^level
- 速度: ×1.03^level
- 伤害: ×1.10^level
- 生成数量: ×1.12^level

### 5.3 BPM 节奏生成

敌人在弱拍时刻生成，与敌人的弱拍移动形成呼应。

---

## 6. 实现架构

```
enemy_base.gd (基类)
├── enemies/enemy_static.gd
├── enemies/enemy_silence.gd
├── enemies/enemy_screech.gd
├── enemies/enemy_pulse.gd
└── enemies/enemy_wall.gd

enemy_spawner.gd (生成器)
├── 波次系统
├── BPM 节奏生成
├── 难度缩放
└── 经验值拾取物生成

death_vfx_manager.gd (死亡特效)
├── 对象池碎片系统
├── 类型差异化特效
└── 屏幕震动

xp_pickup.gd (经验值拾取物)
├── 磁吸机制
├── 颜色分级
└── 节拍脉冲
```

### 5.1 信号系统

```
enemy_died(position, xp_value, enemy_type)  → Spawner, VFX, XP
enemy_damaged(current_hp, max_hp, damage)   → UI (血条/伤害数字)
enemy_stunned(duration)                     → VFX
```

---

## 7. 总结

Project Harmony 的敌人不是生物，而是**视听符号**。它们的设计围绕「干扰」展开：

- **视觉上**是故障的、低帧率的几何碎片。
- **听觉上**（建议）死亡时发出破音或噪音。
- **机制上**通过量化移动带来机械的压迫感，迫使玩家用流畅的「和弦」去净化这些「噪音」。
