# KB-003: 解决 Godot 4 中 2.5D 渲染遮挡问题

**问题编号:** KB-003  
**创建日期:** 2026-02-12  
**作者:** Manus AI Agent

---

## 1. 问题背景

在 Project Harmony 的 2.5D 渲染方案中，使用 `RenderBridge3D` 节点将 3D 渲染效果（如动态光照、Glow）叠加在 2D 游戏世界上。该方案的核心是将 3D 场景渲染到一个独立的 `SubViewport` 中，然后通过一个全屏的 `SubViewportContainer` 将其绘制在 2D 内容之上的 `CanvasLayer` 中。

在开发过程中，发现 2D 弹体（使用 `MultiMeshInstance2D` 绘制）在 3D 渲染层启用时完全不可见。

## 2. 根因分析

- **渲染层级:**
  - 2D 弹体 (`ProjectileManager`) 在默认的 `CanvasLayer` (layer 0) 中绘制。
  - 3D 叠加层 (`RenderBridge3D`) 创建了一个新的 `CanvasLayer` (layer 5)，并在其中放置了 `SubViewportContainer`。
  - 由于 layer 5 在 layer 0 之上，`SubViewportContainer` 会覆盖 2D 弹体。

- **透明度问题:**
  - `SubViewport` 设置了 `transparent_bg = true`，理论上其透明区域应该能让下层的 2D 内容透过来。
  - **关键问题:** Godot 4 中存在一个已知问题 ([Issue #28141](https://github.com/godotengine/godot/issues/28141))，当 `SubViewport` 的 `WorldEnvironment` 启用了 Glow/Bloom 等后处理效果时，这些效果会**污染透明通道**。即使背景设置为完全透明 `Color(0, 0, 0, 0)`，Glow 的辉光也会在透明区域产生非零的 alpha 值。

- **混合模式问题:**
  - `SubViewportContainer` 默认使用 `BLEND_MODE_MIX` 混合模式。
  - 当从 `SubViewport` 得到的纹理包含被 Glow 污染的、非完全透明的黑色像素时，`Mix` 模式会将这些半透明的黑色与下层的 2D 弹体混合，导致弹体变暗甚至完全不可见。

## 3. 解决方案

解决方案的核心是改变 `SubViewportContainer` 的混合模式，使其不再遮挡下层内容。

### 3.1. 核心修复

在 `render_bridge_3d.gd` 中，为 `_viewport_container` 创建并设置一个 `CanvasItemMaterial`，将其混合模式设置为 `BLEND_MODE_PREMULT_ALPHA`。

```gdscript
# In render_bridge_3d.gd, inside _build_3d_scene()

# ... after _viewport_container is created ...

# ★ 修复弹体不可见：使用 Premultiplied Alpha 混合模式
# Godot Issue #28141: Glow 后处理会污染透明通道，导致 SubViewportContainer
# 在默认 Mix 混合模式下遮挡下层 2D 内容（包括弹体 MultiMesh）
# 使用 CanvasItemMaterial + BLEND_MODE_PREMULT_ALPHA 确保透明区域不遮挡
var overlay_material := CanvasItemMaterial.new()
overlay_material.blend_mode = CanvasItemMaterial.BLEND_MODE_PREMULT_ALPHA
_viewport_container.material = overlay_material
```

### 3.2. 备选方案：加法混合

如果 `PREMULT_ALPHA` 模式下的视觉效果不理想，还可以尝试 `BLEND_MODE_ADD`（加法混合）。

```gdscript
overlay_material.blend_mode = CanvasItemMaterial.BLEND_MODE_ADD
```

加法混合会将 3D 层的颜色值直接加到 2D 层上。这意味着 3D 层的黑色区域（`Color(0,0,0)`）将完全透明，而光效会以叠加的方式提亮 2D 内容，通常能产生理想的视觉效果且性能良好。

## 4. 关键文件依赖

- `godot_project/scripts/systems/render_bridge_3d.gd` (2.5D 渲染核心)
- `godot_project/scripts/systems/projectile_manager.gd` (被遮挡的 2D 系统)
